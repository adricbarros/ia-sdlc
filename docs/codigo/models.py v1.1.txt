# CODIGO CORRIGIDO PELO GEMINI RAPIDO V1.1

from sqlalchemy import create_engine, Column, Integer, String, Text, Float, Date, ForeignKey, func
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import relationship
from werkzeug.security import generate_password_hash, check_password_hash
from sqlalchemy import Computed # Correção de inconformidade com o prompt feito pela IA

Base = declarative_base()

class Secretaria(Base):
    __tablename__ = 'secretarias'
    
    id = Column(Integer, primary_key=True)
    nome = Column(String(255), nullable=False)
    
    contratacoes = relationship('Contratacao', back_populates='secretaria')
    usuarios = relationship('Usuario', back_populates='secretaria')

class Usuario(Base):
    __tablename__ = 'usuarios'
    
    id = Column(Integer, primary_key=True)
    nome = Column(String(255), nullable=False)
    login = Column(String(100), unique=True, nullable=False)
    senha = Column(String(255), nullable=False)
    secretaria_id = Column(Integer, ForeignKey('secretarias.id'), nullable=False)
    
    secretaria = relationship('Secretaria', back_populates='usuarios')
    
    def set_password(self, password):
        self.senha = generate_password_hash(password)
    
    def check_password(self, password):
        return check_password_hash(self.senha, password)


class Contratacao(Base):  # AQUI ESTÁ O MODELO DE CONTRATAÇÃO, COM O CAMPO COMPUTADO PARA O CÓDIGO IDENTIFICADOR
    __tablename__ = 'contratacoes'
    
    id = Column(Integer, primary_key=True, autoincrement=True)
    exercicio = Column(Integer, nullable=False)
    objeto = Column(String(500), nullable=False)
    descricao = Column(Text)
    valor_estimado = Column(Float)
    dotacao = Column(String(100))
    data_planejada = Column(Date)
    secretaria_id = Column(Integer, ForeignKey('secretarias.id'), nullable=False)
    
    # AQUI ESTÁ A MÁGICA DO MYSQL 9.1 + SQLALCHEMY:
    # O banco concatena automaticamente. 'PERSISTED' permite criar índices para busca rápida.
    codigo_identificador = Column(
        String(100), 
        Computed(
            f"CONCAT('PCA-', id, '.', exercicio, '-', secretaria_id)", 
            persisted=True
        ),
        unique=True
    )
    
    secretaria = relationship('Secretaria', back_populates='contratacoes')

# Configuração da conexão
DATABASE_URL = "mysql+pymysql://user:password@localhost/database_name"
engine = create_engine(DATABASE_URL)
Base.metadata.create_all(engine)