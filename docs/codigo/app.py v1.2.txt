# CODIGO CORRIGIDO GEMINI PRO V 1.2

import os
import io
import pandas as pd
from datetime import datetime
from flask import Flask, render_template, request, redirect, url_for, flash, session, send_file
from reportlab.lib.pagesizes import A4
from reportlab.pdfgen import canvas
from models import db, Usuario, Secretaria, Contratacao
from dotenv import load_dotenv
load_dotenv() # Carrega as variáveis do arquivo .env

app = Flask(__name__)
app.secret_key = os.environ.get('FLASK_SECRET_KEY', 'chave-padrao-desenvolvimento')

# Configuração de Acesso ao Banco de Dados (MySQL 9.1)
DB_USER = os.environ.get('DB_USER', 'root')
DB_PASS = os.environ.get('DB_PASSWORD', '')
DB_HOST = os.environ.get('DB_HOST', 'localhost')
DB_NAME = os.environ.get('DB_NAME', 'pca_sdlc')

app.config['SQLALCHEMY_DATABASE_URI'] = f"mysql+pymysql://{DB_USER}:{DB_PASS}@{DB_HOST}/{DB_NAME}"
app.config['SQLALCHEMY_TRACK_MODIFICATIONS'] = False

# Vincula o banco de dados à aplicação Flask
db.init_app(app)

# ============================================================================
# INTERFACE PÚBLICA (TRANSPARÊNCIA)
# ============================================================================

@app.route('/')
def home():
    secretarias = Secretaria.query.all()
    
    # Filtros recebidos da URL
    sec_id = request.args.get('secretaria')
    exercicio = request.args.get('exercicio')
    codigo = request.args.get('codigo')

    query = Contratacao.query
    if sec_id: query = query.filter_by(secretaria_id=sec_id)
    if exercicio: query = query.filter_by(exercicio=exercicio)
    if codigo: query = query.filter(Contratacao.codigo_identificador.like(f"%{codigo}%"))

    contratacoes = query.all()
    return render_template('home.html', contratacoes=contratacoes, secretarias=secretarias)

@app.route('/exportar/excel')
def exportar_excel():
    contratacoes = Contratacao.query.all()
    data = [{
        'Código Oficial': c.codigo_identificador,
        'Exercício': c.exercicio,
        'Objeto': c.objeto,
        'Valor Estimado': c.valor_estimado,
        'Secretaria': c.secretaria.nome if c.secretaria else 'N/A'
    } for c in contratacoes]
    
    df = pd.DataFrame(data)
    output = io.BytesIO()
    with pd.ExcelWriter(output, engine='openpyxl') as writer:
        df.to_excel(writer, index=False)
    output.seek(0)
    
    return send_file(output, download_name="PCA_Publico.xlsx", as_attachment=True)

# ============================================================================
# INTERFACE ADMINISTRATIVA
# ============================================================================

@app.route('/admin/login', methods=['GET', 'POST'])
def admin_login():
    if request.method == 'POST':
        user = Usuario.query.filter_by(login=request.form.get('username')).first()
        if user and user.check_password(request.form.get('password')):
            session['user_id'] = user.id
            return redirect(url_for('home')) # Em um app real, iria para um dashboard admin
        flash('Credenciais inválidas.')
    return render_template('admin_login.html')

@app.route('/admin/cadastrar/contratacao', methods=['POST'])
def cadastrar_contratacao():
    if 'user_id' not in session: return redirect(url_for('admin_login'))
    
    try:
        nova_contratacao = Contratacao(
            exercicio=int(request.form.get('exercicio')),
            objeto=request.form.get('objeto'),
            descricao=request.form.get('descricao'),
            valor_estimado=float(request.form.get('valor')),
            dotacao=request.form.get('dotacao'),
            data_planejada=datetime.strptime(request.form.get('data'), '%Y-%m-%d').date(),
            secretaria_id=int(request.form.get('secretaria_id'))
        )
        db.session.add(nova_contratacao)
        db.session.commit()
    except Exception as e:
        db.session.rollback()
        flash(f'Erro ao cadastrar: {str(e)}')
        
    return redirect(url_for('home'))

if __name__ == '__main__':
    with app.app_context():
        # 1. Cria todas as tabelas no MySQL baseadas no models.py
        db.create_all()
        
        # 2. Verifica se existe pelo menos uma Secretaria (Obrigatório para o FK)
        sec_padrao = Secretaria.query.filter_by(nome='Secretaria de Administração').first()
        if not sec_padrao:
            sec_padrao = Secretaria(nome='Secretaria de Administração')
            db.session.add(sec_padrao)
            db.session.commit() # Commitamos aqui para gerar o ID da secretaria
            
        # 3. Verifica se o usuário 'admin' existe, se não, cria.
        admin_user = Usuario.query.filter_by(login='admin').first()
        if not admin_user:
            novo_admin = Usuario(
                nome='Administrador do Sistema',
                login='admin',
                secretaria_id=sec_padrao.id
            )
            novo_admin.set_password('admin123') # Usa a função de hash segura do models.py!
            
            db.session.add(novo_admin)
            db.session.commit()
            print("Bootstrapping concluído: Secretaria Padrão e Usuário Admin criados.")

    # Inicia o servidor Flask
    app.run(debug=True, host='0.0.0.0')