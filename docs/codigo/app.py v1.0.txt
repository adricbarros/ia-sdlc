# CODIGO ORIGINAL GERADO PELA IA COM ERRO

import os
import json
from flask import Flask, render_template, request, jsonify, send_file, session, redirect, url_for
from flask_mysqldb import MySQL
import pandas as pd
from reportlab.lib.pagesizes import letter, A4
from reportlab.platypus import SimpleDocTemplate, Table, TableStyle, Paragraph, Spacer
from reportlab.lib.styles import getSampleStyleSheet, ParagraphStyle
from reportlab.lib import colors
from datetime import datetime
import io
from functools import wraps

import MySQLdb.cursors

app = Flask(__name__)
app.secret_key = 'sua_chave_secreta_aqui'

# Configuração MySQL com tratamento de erro robusto
try:
    app.config['MYSQL_HOST'] = os.environ.get('DB_HOST', 'localhost')
    app.config['MYSQL_USER'] = 'root'
    app.config['MYSQL_PASSWORD'] = os.environ.get('DB_PASSWORD', '')
    app.config['MYSQL_DB'] = 'pca_sdlc'
    mysql = MySQL(app)
except Exception as e:
    print(f"Erro ao conectar ao MySQL: {e}")
    mysql = None

# ============================================================================
# SEGURANÇA: Decorator para proteger rotas administrativas
# Apenas usuários autenticados na sessão podem acessar /admin
# ============================================================================
def login_required(f):
    @wraps(f)
    def decorated_function(*args, **kwargs):
        if 'user_id' not in session:
            return redirect(url_for('admin_login'))
        return f(*args, **kwargs)
    return decorated_function

# ============================================================================
# INTERFACE PÚBLICA - Transparência e Democracia Aberta
# ============================================================================

@app.route('/')
def home():
    """
    Rota principal (home) - Acesso público sem autenticação
    Permite cidadãos pesquisarem Contratações por múltiplos critérios
    SEGURANÇA: Sem restriction - dados são públicos de acordo com LGPD
    """
    return render_template('home.html')

@app.route('/api/contratacoes', methods=['GET'])
def buscar_contratacoes():
    """
    API para buscar contratações com filtros
    SEGURANÇA: Endpoint público, sem autenticação necessária
    """
    if not mysql:
        return jsonify({'erro': 'Conexão com banco de dados indisponível'}), 503
    
    try:
        secretaria = request.args.get('secretaria', '')
        exercicio = request.args.get('exercicio', '')
        codigo = request.args.get('codigo_identificador', '')
        
        cursor = mysql.connection.cursor(MySQLdb.cursors.DictCursor)
        
        query = "SELECT * FROM contratacoes WHERE 1=1"
        params = []
        
        if secretaria:
            query += " AND secretaria_id = %s"
            params.append(secretaria)
        if exercicio:
            query += " AND exercicio = %s"
            params.append(exercicio)
        if codigo:
            query += " AND codigo_identificador LIKE %s"
            params.append(f"%{codigo}%")
        
        cursor.execute(query, params)
        contratacoes = cursor.fetchall()
        cursor.close()
        
        return jsonify(contratacoes)
    except MySQLdb.Error as e:
        return jsonify({'erro': f'Erro de banco de dados: {str(e)}'}), 500
    except Exception as e:
        return jsonify({'erro': f'Erro interno: {str(e)}'}), 500

@app.route('/api/secretarias', methods=['GET'])
def listar_secretarias():
    """
    Retorna lista de secretarias para filtro público
    """
    if not mysql:
        return jsonify([]), 503
    
    try:
        cursor = mysql.connection.cursor(MySQLdb.cursors.DictCursor)
        cursor.execute("SELECT id, nome FROM secretarias")
        secretarias = cursor.fetchall()
        cursor.close()
        return jsonify(secretarias)
    except Exception as e:
        return jsonify({'erro': str(e)}), 500

@app.route('/exportar/pdf', methods=['POST'])
def exportar_pdf():
    """
    Exporta resultados de busca para PDF
    SEGURANÇA: Dados públicos, sem restrição de acesso
    """
    if not mysql:
        return jsonify({'erro': 'Serviço indisponível'}), 503
    
    try:
        data = request.get_json()
        filtros = data.get('filtros', {})
        
        # Recupera dados com filtros
        cursor = mysql.connection.cursor(MySQLdb.cursors.DictCursor)
        query = "SELECT codigo_identificador, secretaria, exercicio, valor FROM contratacoes WHERE 1=1"
        params = []
        
        if filtros.get('secretaria'):
            query += " AND secretaria_id = %s"
            params.append(filtros['secretaria'])
        
        cursor.execute(query, params)
        contratacoes = cursor.fetchall()
        cursor.close()
        
        # Cria PDF
        buffer = io.BytesIO()
        doc = SimpleDocTemplate(buffer, pagesize=A4)
        elements = []
        
        title_style = ParagraphStyle(
            'CustomTitle',
            parent=getSampleStyleSheet()['Title'],
            fontSize=16,
            textColor=colors.HexColor('#003366')
        )
        elements.append(Paragraph("Relatório de Contratações PCA", title_style))
        elements.append(Spacer(1, 12))
        
        # Tabela de dados
        if contratacoes:
            data_table = [['Código', 'Secretaria', 'Exercício', 'Valor']]
            for c in contratacoes:
                data_table.append([
                    c.get('codigo_identificador', ''),
                    c.get('secretaria', ''),
                    str(c.get('exercicio', '')),
                    f"R$ {c.get('valor', 0):.2f}"
                ])
            
            table = Table(data_table)
            table.setStyle(TableStyle([
                ('BACKGROUND', (0, 0), (-1, 0), colors.HexColor('#003366')),
                ('TEXTCOLOR', (0, 0), (-1, 0), colors.whitesmoke),
                ('ALIGN', (0, 0), (-1, -1), 'CENTER'),
                ('FONTNAME', (0, 0), (-1, 0), 'Helvetica-Bold'),
                ('FONTSIZE', (0, 0), (-1, 0), 10),
                ('BOTTOMPADDING', (0, 0), (-1, 0), 12),
                ('GRID', (0, 0), (-1, -1), 1, colors.grey)
            ]))
            elements.append(table)
        
        doc.build(elements)
        buffer.seek(0)
        
        return send_file(
            buffer,
            mimetype='application/pdf',
            as_attachment=True,
            download_name=f'contratacoes_{datetime.now().strftime("%Y%m%d_%H%M%S")}.pdf'
        )
    except Exception as e:
        return jsonify({'erro': str(e)}), 500

@app.route('/exportar/excel', methods=['POST'])
def exportar_excel():
    """
    Exporta resultados de busca para Excel
    SEGURANÇA: Dados públicos, sem restrição de acesso
    """
    if not mysql:
        return jsonify({'erro': 'Serviço indisponível'}), 503
    
    try:
        data = request.get_json()
        filtros = data.get('filtros', {})
        
        cursor = mysql.connection.cursor(MySQLdb.cursors.DictCursor)
        query = "SELECT * FROM contratacoes WHERE 1=1"
        params = []
        
        if filtros.get('secretaria'):
            query += " AND secretaria_id = %s"
            params.append(filtros['secretaria'])
        if filtros.get('exercicio'):
            query += " AND exercicio = %s"
            params.append(filtros['exercicio'])
        
        cursor.execute(query, params)
        contratacoes = cursor.fetchall()
        cursor.close()
        
        df = pd.DataFrame(contratacoes)
        buffer = io.BytesIO()
        df.to_excel(buffer, index=False)
        buffer.seek(0)
        
        return send_file(
            buffer,
            mimetype='application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
            as_attachment=True,
            download_name=f'contratacoes_{datetime.now().strftime("%Y%m%d_%H%M%S")}.xlsx'
        )
    except Exception as e:
        return jsonify({'erro': str(e)}), 500

# ============================================================================
# INTERFACE ADMINISTRATIVA - Privada com Autenticação
# SEGURANÇA: Todas as rotas /admin requerem autenticação via session
# ============================================================================

@app.route('/admin/login', methods=['GET', 'POST'])
def admin_login():
    """
    Login administrativo
    SEGURANÇA: Valida credenciais contra banco de dados
    Usa sessão Flask para manter autenticação
    """
    if request.method == 'POST':
        if not mysql:
            return jsonify({'erro': 'Banco indisponível'}), 503
        
        try:
            username = request.form.get('username')
            password = request.form.get('password')
            
            cursor = mysql.connection.cursor(MySQLdb.cursors.DictCursor)
            cursor.execute("SELECT id, nome FROM usuarios WHERE username = %s AND password = %s", 
                          (username, password))
            user = cursor.fetchone()
            cursor.close()
            
            if user:
                session['user_id'] = user['id']
                session['username'] = user['nome']
                return redirect(url_for('admin_dashboard'))
            else:
                return render_template('admin_login.html', erro='Credenciais inválidas')
        except Exception as e:
            return render_template('admin_login.html', erro=f'Erro: {str(e)}')
    
    return render_template('admin_login.html')

@app.route('/admin/logout')
def admin_logout():
    """Encerra sessão administrativa"""
    session.clear()
    return redirect(url_for('home'))

@app.route('/admin/dashboard')
@login_required
def admin_dashboard():
    """
    Dashboard administrativo (área logada)
    SEGURANÇA: Requer autenticação via decorator @login_required
    """
    return render_template('admin_dashboard.html', username=session.get('username'))

@app.route('/admin/usuarios', methods=['GET', 'POST'])
@login_required
def gerenciar_usuarios():
    """
    CRUD de Usuários
    SEGURANÇA: Apenas administradores logados
    """
    if not mysql:
        return jsonify({'erro': 'Banco indisponível'}), 503
    
    try:
        if request.method == 'POST':
            nome = request.form.get('nome')
            username = request.form.get('username')
            password = request.form.get('password')
            
            cursor = mysql.connection.cursor()
            cursor.execute(
                "INSERT INTO usuarios (nome, username, password) VALUES (%s, %s, %s)",
                (nome, username, password)
            )
            mysql.connection.commit()
            cursor.close()
            
            return jsonify({'sucesso': True, 'mensagem': 'Usuário criado'}), 201
        
        else:  # GET
            cursor = mysql.connection.cursor(MySQLdb.cursors.DictCursor)
            cursor.execute("SELECT id, nome, username FROM usuarios")
            usuarios = cursor.fetchall()
            cursor.close()
            return render_template('admin_usuarios.html', usuarios=usuarios)
    
    except Exception as e:
        return jsonify({'erro': str(e)}), 500

@app.route('/admin/secretarias', methods=['GET', 'POST'])
@login_required
def gerenciar_secretarias():
    """
    CRUD de Secretarias
    SEGURANÇA: Apenas administradores logados
    """
    if not mysql:
        return jsonify({'erro': 'Banco indisponível'}), 503
    
    try:
        if request.method == 'POST':
            nome = request.form.get('nome')
            
            cursor = mysql.connection.cursor()
            cursor.execute("INSERT INTO secretarias (nome) VALUES (%s)", (nome,))
            mysql.connection.commit()
            cursor.close()
            
            return jsonify({'sucesso': True}), 201
        
        else:
            cursor = mysql.connection.cursor(MySQLdb.cursors.DictCursor)
            cursor.execute("SELECT id, nome FROM secretarias")
            secretarias = cursor.fetchall()
            cursor.close()
            return render_template('admin_secretarias.html', secretarias=secretarias)
    
    except Exception as e:
        return jsonify({'erro': str(e)}), 500

@app.route('/admin/contratacoes', methods=['GET', 'POST'])
@login_required
def gerenciar_contratacoes():
    """
    CRUD de Contratações PCA
    SEGURANÇA: Apenas administradores logados
    Registra todas as alterações para auditoria
    """
    if not mysql:
        return jsonify({'erro': 'Banco indisponível'}), 503
    
    try:
        if request.method == 'POST':
            codigo = request.form.get('codigo_identificador')
            secretaria_id = request.form.get('secretaria_id')
            exercicio = request.form.get('exercicio')
            valor = request.form.get('valor')
            descricao = request.form.get('descricao')
            
            cursor = mysql.connection.cursor()
            cursor.execute(
                """INSERT INTO contratacoes 
                   (codigo_identificador, secretaria_id, exercicio, valor, descricao, data_criacao)
                   VALUES (%s, %s, %s, %s, %s, NOW())""",
                (codigo, secretaria_id, exercicio, valor, descricao)
            )
            mysql.connection.commit()
            cursor.close()
            
            return jsonify({'sucesso': True}), 201
        
        else:
            cursor = mysql.connection.cursor(MySQLdb.cursors.DictCursor)
            cursor.execute("""
                SELECT c.*, s.nome as secretaria 
                FROM contratacoes c
                JOIN secretarias s ON c.secretaria_id = s.id
                ORDER BY c.data_criacao DESC
            """)
            contratacoes = cursor.fetchall()
            
            cursor.execute("SELECT id, nome FROM secretarias")
            secretarias = cursor.fetchall()
            cursor.close()
            
            return render_template('admin_contratacoes.html', 
                                 contratacoes=contratacoes,
                                 secretarias=secretarias)
    
    except Exception as e:
        return jsonify({'erro': str(e)}), 500

# ============================================================================
# Tratamento de erros global
# ============================================================================

@app.errorhandler(404)
def nao_encontrado(error):
    return jsonify({'erro': 'Página não encontrada'}), 404

@app.errorhandler(500)
def erro_interno(error):
    return jsonify({'erro': 'Erro interno do servidor'}), 500

if __name__ == '__main__':
    app.run(debug=True, host='0.0.0.0', port=5000)