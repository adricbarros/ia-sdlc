name: SDLC Pipeline - PCAWeb

on:
  push:
    branches:
      - main

jobs:
  # =========================================================
  # 1. CI: INTEGRAÇÃO E QUALIDADE (Roda na Nuvem do GitHub)
  # =========================================================
  integracao_e_qualidade:
    name: Testes e SonarCloud
    runs-on: ubuntu-latest
    steps:
      - name: Checkout do código
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configurar Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11.9'

      - name: Instalar dependências e rodar testes
        env:
          AMBIENTE_DE_TESTE: 'True'
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt pytest pytest-cov
          pytest --cov=. --cov-report=xml

      - name: SonarCloud Scan (Com Trava Absoluta)
        uses: SonarSource/sonarcloud-github-action@master
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          # O 'wait=true' força a esteira a esperar a nota final. 
          # Se o Quality Gate falhar, a esteira QUEBRA AQUI e não avança!
          args: >
            -Dsonar.qualitygate.wait=true

  # =========================================================
  # 2. CD: HOMOLOGAÇÃO (Deploy Automático no Debian Local)
  # =========================================================
  deploy_homologacao:
    name: Deploy em Homologação (Debian)
    needs: integracao_e_qualidade # Só roda se o Job 1 (Sonar) ficar verde
    runs-on: self-hosted # Aponta para o seu Debian físico/local
    environment: homologacao
    steps:
      - name: Puxar código e reiniciar
        uses: actions/checkout@v4
      
      - name: Preparar Ambiente e Reiniciar Serviço
        run: |
          # (Aqui entram os seus comandos de venv e systemctl que já funcionavam)
          source venv/bin/activate
          pip install -r requirements.txt
          sudo chown -R trap:trap .
          sudo /usr/bin/systemctl restart ia-sdlc.service

  # =========================================================
  # 3. CD: PRODUÇÃO (Deploy com Aprovação Manual na Oracle Cloud)
  # =========================================================
  deploy_producao:
    name: Deploy em Produção (Oracle Cloud)
    needs: deploy_homologacao # Só libera se Homologação deu certo
    runs-on: ubuntu-latest # Roda na nuvem e acessa a Oracle via SSH
    environment: producao # <--- ESTA LINHA ACIONA O BOTÃO DE APROVAÇÃO NO GITHUB
    steps:
      - name: Checkout do código
        uses: actions/checkout@v4
        
      - name: Deploy via SSH na Oracle Cloud
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.ORACLE_HOST_IP }}
          username: ${{ secrets.ORACLE_USER }} # Geralmente 'ubuntu' ou 'opc'
          key: ${{ secrets.ORACLE_SSH_KEY }}
          script: |
            # Comandos que serão executados lá dentro da Oracle Cloud
            cd /caminho/do/seu/projeto/pcaweb
            git pull origin main
            source venv/bin/activate
            pip install -r requirements.txt
            sudo systemctl restart pcaweb-prod.service